<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>美甲服務計算機</title>
    <style>
        :root {
            /* 根據您提供的色票定義變數 */
            --c-dark-brown: #876D5A;
            --c-med-brown: #9D7553;
            --c-light-brown: #A98B73;
            --c-beige: #CDA581;
            --c-skin: #DABEA7;
            --c-deep-red: #9A6852;
            --c-bg: #F9F5F2; /* 比色票最淺色更淺一點，適合做背景 */
            --c-white: #ffffff;
            --radius: 12px;
            --shadow: 0 4px 6px rgba(135, 109, 90, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--c-bg);
            color: var(--c-dark-brown);
            margin: 0;
            padding: 0;
            padding-bottom: 140px; /* 留給底部結帳欄空間 */
        }

        /* Header */
        header {
            background-color: var(--c-med-brown);
            color: var(--c-white);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 500; letter-spacing: 1px; }
        .icon-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; }

        /* Tabs */
        .tabs {
            display: flex;
            overflow-x: auto;
            background: var(--c-white);
            padding: 10px 5px;
            position: sticky;
            top: 58px;
            z-index: 99;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-btn {
            flex: 0 0 auto;
            padding: 8px 16px;
            margin: 0 5px;
            border: 1px solid var(--c-light-brown);
            border-radius: 20px;
            color: var(--c-dark-brown);
            background: transparent;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background-color: var(--c-light-brown);
            color: white;
            border-color: var(--c-light-brown);
        }

        /* Item Grid */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 手機預設兩欄 */
            gap: 12px;
            padding: 15px;
        }
        
        .item-card {
            background: var(--c-white);
            border-radius: var(--radius);
            padding: 15px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.1s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100px;
            position: relative;
        }
        .item-card:active { transform: scale(0.98); background-color: var(--c-skin); }
        .item-name { font-size: 1rem; font-weight: bold; margin-bottom: 5px; line-height: 1.3; }
        .item-price { color: var(--c-deep-red); font-weight: bold; font-size: 1.1rem; }
        .item-note { font-size: 0.8rem; color: #999; margin-top: 3px; }

        /* Specific styles based on category */
        .cat-hand .item-card { border-bottom: 4px solid var(--c-med-brown); }
        .cat-foot .item-card { border-bottom: 4px solid var(--c-deep-red); }
        .cat-care .item-card { border-bottom: 4px solid var(--c-beige); }
        .cat-other .item-card { border-bottom: 4px solid var(--c-dark-brown); }

        /* Cart / Bill Section */
        .bill-area {
            margin: 15px;
            background: var(--c-white);
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
        }
        .bill-title { font-size: 1rem; font-weight: bold; border-bottom: 1px dashed var(--c-light-brown); padding-bottom: 10px; margin-bottom: 10px; }
        .bill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .bill-item-info { flex-grow: 1; }
        .bill-item-name { font-weight: 500; }
        .bill-item-sub { font-size: 0.85rem; color: #888; }
        .bill-item-price { font-weight: bold; min-width: 60px; text-align: right; color: var(--c-deep-red); }
        .bill-action { margin-left: 10px; color: #ccc; cursor: pointer; padding: 5px; }
        .bill-action:hover { color: red; }

        /* Footer Sticky Bar */
        .footer-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--c-white);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 200;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--c-dark-brown);
        }
        .actions-row {
            display: flex;
            gap: 10px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-reset { background-color: #eee; color: #666; flex: 0.4; }
        .btn-copy { background-color: var(--c-med-brown); color: white; }

        /* Modal (Settings & Input) */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; text-align: center; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .input-group input { 
            width: 100%; padding: 10px; 
            border: 1px solid #ccc; border-radius: 6px; 
            font-size: 1.1rem; 
        }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }

        /* Price Edit List */
        .price-edit-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        .price-edit-row input { width: 80px; padding: 5px; }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 400;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

<header>
    <h1>Nail POS 計算機</h1>
    <button class="icon-btn" onclick="openSettings()">⚙️</button>
</header>

<div class="tabs" id="categoryTabs">
    <!-- Generated by JS -->
</div>

<div class="grid-container" id="itemGrid">
    <!-- Generated by JS -->
</div>

<div class="bill-area">
    <div class="bill-title">結帳明細</div>
    <div id="cartList">
        <div style="text-align:center; color:#ccc; padding:10px;">尚未選擇項目</div>
    </div>
</div>

<div class="footer-bar">
    <div class="total-row">
        <span>總金額</span>
        <span id="totalDisplay">$0</span>
    </div>
    <div class="actions-row">
        <button class="btn btn-reset" onclick="resetCart()">清空</button>
        <button class="btn btn-copy" onclick="copyBill()">複製明細 + 總額</button>
    </div>
</div>

<!-- Modal: Dynamic Input (Price/Qty) -->
<div class="modal" id="inputModal">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle">項目設定</div>
        <div class="input-group">
            <label>單價 (可修改)</label>
            <input type="number" id="modalPrice" inputmode="numeric">
        </div>
        <div class="input-group">
            <label>數量 / 指數</label>
            <div style="display:flex; align-items:center; gap:10px;">
                <button class="btn btn-reset" onclick="adjQty(-1)" style="font-size:1.5rem">-</button>
                <input type="number" id="modalQty" value="1" inputmode="numeric" style="text-align:center;">
                <button class="btn btn-reset" onclick="adjQty(1)" style="font-size:1.5rem">+</button>
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-reset" onclick="closeModal('inputModal')">取消</button>
            <button class="btn btn-copy" onclick="confirmAddItem()">確認加入</button>
        </div>
    </div>
</div>

<!-- Modal: Settings (Edit Prices) -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">編輯價目表</div>
        <div style="margin-bottom:15px; font-size:0.9rem; color:#666;">
            修改後會自動儲存在此瀏覽器中。
        </div>
        <div id="settingsList">
            <!-- Price inputs generated here -->
        </div>
        <div class="modal-actions">
            <button class="btn btn-reset" onclick="factoryReset()">回復預設值</button>
            <button class="btn btn-copy" onclick="saveSettings()">儲存並關閉</button>
        </div>
    </div>
</div>

<div class="toast" id="toast">已複製到剪貼簿！</div>

<script>
    // --- 1. Data Structure (Based on your images) ---
    // Types: 'fixed' (click adds), 'variable' (click opens modal), 'addon' (input qty)
    const defaultData = [
        // 手部凝膠
        { id: 'h1', cat: 'hand', name: '透明凝膠', price: 2100, type: 'fixed' },
        { id: 'h2', cat: 'hand', name: '單色/彩膠漸層', price: 2480, type: 'fixed' },
        { id: 'h3', cat: 'hand', name: '法式凝膠', price: 3080, type: 'fixed' },
        
        // 足部凝膠
        { id: 'f1', cat: 'foot', name: '足部 透明凝膠', price: 2980, type: 'fixed' },
        { id: 'f2', cat: 'foot', name: '足部 單色/漸層', price: 3300, type: 'fixed' },
        { id: 'f3', cat: 'foot', name: '足部 法式', price: 3680, type: 'fixed' },
        { id: 'f4', cat: 'foot', name: '足部 升級去硬皮', price: 1180, type: 'fixed', note: '做凝膠加購' },

        // 造型/加購 (Variable items mainly)
        { id: 'a1', cat: 'art', name: '跳色 (3色以上)', price: 100, type: 'fixed', note: '一色+100' },
        { id: 'a2', cat: 'art', name: '亮片/貼紙/夾心', price: 150, type: 'variable', note: '起/指' },
        { id: 'a3', cat: 'art', name: '貓眼磁石', price: 100, type: 'variable', note: '起/指' },
        { id: 'a4', cat: 'art', name: '鏡面粉', price: 250, type: 'variable', note: '起/指' },
        { id: 'a5', cat: 'art', name: '彩繪/暈染', price: 250, type: 'variable', note: '起/指' },
        { id: 'a6', cat: 'art', name: '特殊造型', price: 400, type: 'variable', note: '起/指' },
        { id: 'a7', cat: 'art', name: '真甲斷裂修補', price: 350, type: 'variable', note: '網布/指' },
        { id: 'a8', cat: 'art', name: '足部大姆指延甲', price: 450, type: 'variable', note: '每指' },

        // 保養
        { id: 'c1', cat: 'care', name: '手部基礎保養', price: 1280, type: 'fixed' },
        { id: 'c2', cat: 'care', name: '足部基礎保養', price: 1780, type: 'fixed' },
        { id: 'c3', cat: 'care', name: '足部瞬效保養', price: 3180, type: 'fixed', note: '含去硬皮' },
        { id: 'c4', cat: 'care', name: '足部深層滋潤', price: 4380, type: 'fixed', note: '至膝蓋' },
        { id: 'c5', cat: 'care', name: '加購 敷膜', price: 1400, type: 'fixed', note: '至膝蓋' },

        // 卸甲
        { id: 'r1', cat: 'remove', name: '本店卸甲', price: 500, type: 'fixed' },
        { id: 'r2', cat: 'remove', name: '他店卸甲', price: 1380, type: 'fixed' },
        { id: 'r3', cat: 'remove', name: '續作折抵卸甲', price: -200, type: 'fixed', note: '扣除金額' },
    ];

    const categories = [
        { id: 'hand', name: '手部凝膠' },
        { id: 'foot', name: '足部凝膠' },
        { id: 'art', name: '造型加購' },
        { id: 'care', name: '手足保養' },
        { id: 'remove', name: '卸甲/其他' }
    ];

    // --- 2. State Management ---
    let menuData = [];
    let cart = [];
    let currentCategory = 'hand';
    let tempItem = null; // For modal handling

    // Initialize
    function init() {
        // Load settings from local storage or use default
        const storedData = localStorage.getItem('nailPosData_v3');
        if (storedData) {
            menuData = JSON.parse(storedData);
        } else {
            menuData = JSON.parse(JSON.stringify(defaultData));
        }

        renderTabs();
        renderGrid();
        renderCart();
    }

    // --- 3. Rendering ---
    function renderTabs() {
        const container = document.getElementById('categoryTabs');
        container.innerHTML = categories.map(c => 
            `<button class="tab-btn ${c.id === currentCategory ? 'active' : ''}" 
                     onclick="switchCategory('${c.id}')">${c.name}</button>`
        ).join('');
    }

    function switchCategory(catId) {
        currentCategory = catId;
        renderTabs();
        renderGrid();
    }

    function renderGrid() {
        const container = document.getElementById('itemGrid');
        container.className = `grid-container cat-${currentCategory}`; // For specific category styling
        
        const items = menuData.filter(i => i.cat === currentCategory);
        
        container.innerHTML = items.map(item => `
            <div class="item-card" onclick="handleItemClick('${item.id}')">
                <div class="item-name">${item.name}</div>
                <div class="item-price">${item.price < 0 ? '-' : ''}$${Math.abs(item.price)}</div>
                ${item.note ? `<div class="item-note">${item.note}</div>` : ''}
            </div>
        `).join('');
    }

    function renderCart() {
        const list = document.getElementById('cartList');
        const totalDisplay = document.getElementById('totalDisplay');
        
        if (cart.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:#ccc; padding:10px;">尚未選擇項目</div>`;
            totalDisplay.innerText = "$0";
            return;
        }

        let total = 0;
        list.innerHTML = cart.map((item, index) => {
            let subTotal = item.price * item.qty;
            total += subTotal;
            // 顯示邏輯：如果是變動價格或有數量，顯示細節
            let detailStr = item.qty > 1 ? `x ${item.qty}` : '';
            if (item.isVariable) detailStr += ` (單價$${item.price})`;
            
            return `
            <div class="bill-item">
                <div class="bill-item-info">
                    <div class="bill-item-name">${item.name}</div>
                    ${detailStr ? `<div class="bill-item-sub">${detailStr}</div>` : ''}
                </div>
                <div class="bill-item-price">$${subTotal}</div>
                <div class="bill-action" onclick="removeFromCart(${index})">✕</div>
            </div>`;
        }).join('');

        totalDisplay.innerText = "$" + total;
    }

    // --- 4. Logic ---
    
    function handleItemClick(id) {
        const item = menuData.find(i => i.id === id);
        
        if (item.type === 'fixed') {
            // 直接加入
            addToCart(item.name, item.price, 1, false);
        } else {
            // 開啟視窗設定價格/數量
            openInputModal(item);
        }
    }

    function addToCart(name, price, qty, isVariable) {
        cart.push({
            name: name,
            price: parseInt(price),
            qty: parseInt(qty),
            isVariable: isVariable
        });
        renderCart();
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); // Scroll to bottom
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    function resetCart() {
        if(confirm('確定要清空明細嗎？')) {
            cart = [];
            renderCart();
        }
    }

    // --- 5. Modals ---

    function openInputModal(item) {
        tempItem = item;
        document.getElementById('modalTitle').innerText = item.name;
        document.getElementById('modalPrice').value = item.price;
        document.getElementById('modalQty').value = 1;
        
        document.getElementById('inputModal').classList.add('active');
        document.getElementById('modalQty').focus(); // Focus on Quantity usually
    }

    function adjQty(delta) {
        const input = document.getElementById('modalQty');
        let val = parseInt(input.value) || 0;
        val += delta;
        if (val < 1) val = 1;
        input.value = val;
    }

    function confirmAddItem() {
        const price = document.getElementById('modalPrice').value;
        const qty = document.getElementById('modalQty').value;
        
        if (!price || !qty) return;

        // 判斷是否有改過預設價格，標記一下
        const isModifiedPrice = parseInt(price) !== tempItem.price;

        addToCart(tempItem.name, price, qty, true); // true means variable/manually set
        closeModal('inputModal');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // --- 6. Settings (Price Editing) ---

    function openSettings() {
        const list = document.getElementById('settingsList');
        // Group by category for cleaner editing
        let html = '';
        categories.forEach(cat => {
            const items = menuData.filter(i => i.cat === cat.id);
            if(items.length > 0) {
                html += `<h3 style="margin-top:15px; border-bottom:1px solid #ddd;">${cat.name}</h3>`;
                items.forEach(item => {
                    html += `
                    <div class="price-edit-row">
                        <span>${item.name}</span>
                        <input type="number" id="edit_${item.id}" value="${item.price}">
                    </div>`;
                });
            }
        });
        list.innerHTML = html;
        document.getElementById('settingsModal').classList.add('active');
    }

    function saveSettings() {
        // Loop through data and update prices from inputs
        menuData.forEach(item => {
            const input = document.getElementById(`edit_${item.id}`);
            if (input) {
                item.price = parseInt(input.value);
            }
        });
        
        // Save to local storage
        localStorage.setItem('nailPosData_v3', JSON.stringify(menuData));
        
        closeModal('settingsModal');
        renderGrid(); // Re-render to show new prices
        showToast("價格表已更新");
    }

    function factoryReset() {
        if(confirm("確定要恢復原始預設價格嗎？所有自定義設定將消失。")) {
            menuData = JSON.parse(JSON.stringify(defaultData));
            localStorage.setItem('nailPosData_v3', JSON.stringify(menuData));
            closeModal('settingsModal');
            renderGrid();
            showToast("已恢復預設值");
        }
    }

    // --- 7. Copy Function ---

    function copyBill() {
        if (cart.length === 0) {
            showToast("購物車是空的");
            return;
        }

        const date = new Date().toLocaleString('zh-TW', { hour12: false, month: 'numeric', day: 'numeric', hour:'2-digit', minute:'2-digit' });
        let text = `【美甲服務明細】\n時間: ${date}\n--------------------\n`;
        let total = 0;

        cart.forEach(item => {
            let sub = item.price * item.qty;
            total += sub;
            text += `${item.name}`;
            if (item.qty > 1) text += ` x${item.qty}`;
            text += ` : $${sub}\n`;
        });

        text += `--------------------\n總計: $${total}`;

        // Modern clipboard API
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showToast("已複製明細！");
            }).catch(err => {
                // Fallback
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    }

    function fallbackCopy(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        showToast("已複製明細！");
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // Start
    init();

</script>

</body>
</html>
